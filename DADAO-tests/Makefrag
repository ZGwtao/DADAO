#
# Makefile for tests
#

DIR_TESTS_SOURCE		:= $(DIR_DADAO_TOP)/DADAO-tests
DIR_TESTS_TARGET		:= $(DIR_DADAO_TARGET)

TESTS_COMMON_MK			:= $(DIR_TESTS_SOURCE)/common.mk

include $(TESTS_COMMON_MK)

TESTS_BMARKS_BARE_SOURCE	:= $(DIR_TESTS_SOURCE)/bmarks-bare/
TESTS_BMARKS_BARE_TARGET	:= $(DIR_TESTS_TARGET)/bmarks-bare/
TESTS_BMARKS_QEMU_SOURCE	:= $(DIR_TESTS_SOURCE)/bmarks-qemu/
TESTS_BMARKS_QEMU_TARGET	:= $(DIR_TESTS_TARGET)/bmarks-qemu/

TESTS_BOOTROM_SOURCE		:= $(DIR_TESTS_SOURCE)/bootrom/
TESTS_BOOTROM_TARGET		:= $(DIR_TESTS_TARGET)/bootrom/

TESTS_ISA_SOURCE			:= $(DIR_TESTS_SOURCE)/isa
TESTS_ISA_BARE_TARGET		:= $(DIR_TESTS_TARGET)/isa-bare
TESTS_ISA_QEMU_TARGET		:= $(DIR_TESTS_TARGET)/isa-qemu

TESTS_SIMPLE_SOURCE			:= $(DIR_TESTS_SOURCE)/simple
TESTS_SIMPLE_TARGET			:= $(DIR_TESTS_TARGET)/simple

tests-bmarks-bare-highfive:
	@rm -fr $(TESTS_BMARKS_BARE_TARGET)
	@mkdir -p $(TESTS_BMARKS_BARE_TARGET)
	@ln -s $(TESTS_BMARKS_BARE_SOURCE)/Makefile $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@echo "src_dir\t\t\t\t:= $(TESTS_BMARKS_BARE_SOURCE)"	>  $(TESTS_BMARKS_BARE_TARGET)/common.mk
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"		>> $(TESTS_BMARKS_BARE_TARGET)/common.mk
	@cat $(TESTS_COMMON_MK)					>> $(TESTS_BMARKS_BARE_TARGET)/common.mk
	@$(DADAO_MAKE) -C $(TESTS_BMARKS_BARE_TARGET)
	@make -C $(DIR_DADAO_TOP)									\
		CHIPYARD_$(VER_CHIPYARD)_DADAO_BINARY=$(TESTS_BMARKS_BARE_TARGET)/dhrystone.dadao	\
		chipyard-$(VER_CHIPYARD)-run-binary-stage5

tests-bmarks-qemu-dhrystone-highfive:
	@rm -fr $(TESTS_BMARKS_QEMU_TARGET)/dhrystone
	@mkdir -p $(TESTS_BMARKS_QEMU_TARGET)/dhrystone
	@cd $(TESTS_BMARKS_QEMU_TARGET)/dhrystone ;					\
		$(DADAO_ELF_GCC)							\
			-static								\
			-save-temps							\
			-DHZ=250							\
			-DTIME								\
			-o $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry			\
			$(TESTS_BMARKS_QEMU_SOURCE)/dhry-c/dhry_1.c			\
			$(TESTS_BMARKS_QEMU_SOURCE)/dhry-c/dhry_2.c
	@$(DADAO_ELF_READELF) -a $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry	> $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry.elf
	@$(DADAO_ELF_OBJDUMP) -lDS $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry	> $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry.dump
	@echo 10 | $(DADAO_QEMU_USER)							\
		-singlestep -strace							\
		-D $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhrystone.qemulog		\
		$(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry

include DADAO-tests/Makefrag-bmarks-qemu-embench
include DADAO-tests/Makefrag-bmarks-qemu-coremark
include DADAO-tests/Makefrag-bmarks-qemu-mibench

include DADAO-tests/Makefrag-simple-multi-arch

tests-bootrom-highfive:
	@rm -fr $(TESTS_BOOTROM_TARGET)
	@mkdir -p $(TESTS_BOOTROM_TARGET)
	@ln -s -t $(TESTS_BOOTROM_TARGET) $(TESTS_COMMON_MK)
	@ln -s -t $(TESTS_BOOTROM_TARGET) $(TESTS_BOOTROM_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>> $(TESTS_BOOTROM_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_BOOTROM_TARGET)/Makefile
	@echo ""													>> $(TESTS_BOOTROM_TARGET)/Makefile
	@echo "src_dir\t\t\t\t:= $(TESTS_BOOTROM_SOURCE)"			>> $(TESTS_BOOTROM_TARGET)/Makefile
	@echo "include Makefrag"									>> $(TESTS_BOOTROM_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_BOOTROM_TARGET)

tests-isa-bare-highfive:
	#
	# TARGET DIR: $(TESTS_ISA_BARE_TARGET)
	# NOTE: CAN ONLY RUN ONE BY ONE, so add j1 option for make
	#
	@rm -fr $(TESTS_ISA_BARE_TARGET)
	@mkdir -p $(TESTS_ISA_BARE_TARGET)
	@ln -s -t $(TESTS_ISA_BARE_TARGET) $(TESTS_COMMON_MK)
	@ln -s -t $(TESTS_ISA_BARE_TARGET) $(TESTS_ISA_SOURCE)/Makefrag
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_ISA_BARE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_ISA_BARE_TARGET)/Makefile
	@echo ""													>> $(TESTS_ISA_BARE_TARGET)/Makefile
	@echo "src_dir\t\t\t\t:= $(TESTS_ISA_SOURCE)"				>> $(TESTS_ISA_BARE_TARGET)/Makefile
	@echo "include Makefrag"									>> $(TESTS_ISA_BARE_TARGET)/Makefile
	@$(DADAO_MAKE) -j1 -C $(TESTS_ISA_BARE_TARGET) dduii-bare
	@$(DADAO_MAKE) -j1 -C $(TESTS_ISA_BARE_TARGET) run-bare

tests-isa-qemu-highfive:
	@rm -fr $(TESTS_ISA_QEMU_TARGET)
	@mkdir -p $(TESTS_ISA_QEMU_TARGET)
	@ln -s $(TESTS_ISA_SOURCE)/Makefile $(TESTS_ISA_QEMU_TARGET)/Makefile
	@echo "src_dir\t\t\t\t:= $(TESTS_ISA_SOURCE)"		>  $(TESTS_ISA_QEMU_TARGET)/common.mk
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"		>> $(TESTS_ISA_QEMU_TARGET)/common.mk
	@cat $(TESTS_COMMON_MK)					>> $(TESTS_ISA_QEMU_TARGET)/common.mk
	# NOTE: CAN ONLY RUN ONE BY ONE, so add j1 option
	@$(DADAO_MAKE) -j1 -C $(TESTS_ISA_QEMU_TARGET) dduii-qemu
	@$(DADAO_MAKE) -j1 -C $(TESTS_ISA_QEMU_TARGET) run-qemu

tests-simple-llvm-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-llvm"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

tests-simple-gcc-elf-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-gcc-elf"							>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

tests-simple-gcc-gnu-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-gcc-gnu"							>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

