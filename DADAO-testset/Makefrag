#
# Makefile for tests
#

DIR_TESTS_SOURCE		:= $(DIR_DADAO_TOP)/DADAO-testset
DIR_TESTS_TARGET		:= $(DIR_DADAO_TARGET)

TESTS_BMARKS_BARE_SOURCE	:= $(DIR_TESTS_SOURCE)/bmarks-bare/
TESTS_BMARKS_BARE_TARGET	:= $(DIR_TESTS_TARGET)/bmarks-bare/
TESTS_BMARKS_QEMU_SOURCE	:= $(DIR_TESTS_SOURCE)/bmarks-qemu/
TESTS_BMARKS_QEMU_TARGET	:= $(DIR_TESTS_TARGET)/bmarks-qemu/

TESTS_SIMPLE_SOURCE			:= $(DIR_TESTS_SOURCE)/simple
TESTS_SIMPLE_TARGET			:= $(DIR_TESTS_TARGET)/simple

tests-bmarks-bare-highfive:
	#
	# TARGET DIR: $(TESTS_BMARKS_BARE_TARGET)
	# NOTE: ONLY dhrystone here
	#
	@rm -fr $(TESTS_BMARKS_BARE_TARGET)
	@mkdir -p $(TESTS_BMARKS_BARE_TARGET)
	@ln -s -t $(TESTS_BMARKS_BARE_TARGET) $(RUNTIME_COMMON_MK)
	@ln -s -t $(TESTS_BMARKS_BARE_TARGET) $(TESTS_BMARKS_BARE_SOURCE)/Makefrag
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>> $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@echo ""													>> $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@echo "src_dir\t\t\t\t:= $(TESTS_BMARKS_BARE_SOURCE)"		>> $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@echo "include Makefrag"									>> $(TESTS_BMARKS_BARE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_BMARKS_BARE_TARGET)
	@make -C $(DIR_DADAO_TOP)																\
		CHIPYARD_$(VER_CHIPYARD)_DADAO_BINARY=$(TESTS_BMARKS_BARE_TARGET)/dhrystone.dadao	\
		chipyard-$(VER_CHIPYARD)-run-binary-stage5

tests-bmarks-qemu-dhrystone-highfive:
	@rm -fr $(TESTS_BMARKS_QEMU_TARGET)/dhrystone
	@mkdir -p $(TESTS_BMARKS_QEMU_TARGET)/dhrystone
	@cd $(TESTS_BMARKS_QEMU_TARGET)/dhrystone ;							\
		$(DADAO_ELF_GCC)												\
			-static														\
			-save-temps													\
			-DHZ=250													\
			-DTIME														\
			-o $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry				\
			$(TESTS_BMARKS_QEMU_SOURCE)/dhry-c/dhry_1.c					\
			$(TESTS_BMARKS_QEMU_SOURCE)/dhry-c/dhry_2.c
	@$(DADAO_ELF_READELF) -a $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry		> $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry.elf
	@$(DADAO_ELF_OBJDUMP) -lDS $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry	> $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry.dump
	@echo 10 | $(DADAO_QEMU_USER)										\
		-singlestep -strace												\
		-D $(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhrystone.qemulog		\
		$(TESTS_BMARKS_QEMU_TARGET)/dhrystone/dhry

include DADAO-testset/Makefrag-bmarks-qemu-embench
include DADAO-testset/Makefrag-bmarks-qemu-coremark
include DADAO-testset/Makefrag-bmarks-qemu-mibench
include DADAO-testset/Makefrag-llvm-testsuite

include DADAO-testset/Makefrag-simple-multi-arch

tests-simple-llvm-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(RUNTIME_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-llvm"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

tests-simple-gcc-elf-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(RUNTIME_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-gcc-elf"							>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

tests-simple-gcc-gnu-highfive:
	#
	# TARGET DIR: $(TESTS_SIMPLE_TARGET)
	#
	@rm -fr $(TESTS_SIMPLE_TARGET)
	@mkdir -p $(TESTS_SIMPLE_TARGET)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(RUNTIME_COMMON_MK)
	@ln -s -t $(TESTS_SIMPLE_TARGET) $(TESTS_SIMPLE_SOURCE)/*
	@echo "DIR_DADAO_TOP\t\t\t:= $(DIR_DADAO_TOP)"				>  $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include common.mk"									>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-gcc-gnu"							>> $(TESTS_SIMPLE_TARGET)/Makefile
	@echo "include Makefrag-run"								>> $(TESTS_SIMPLE_TARGET)/Makefile
	@$(DADAO_MAKE) -C $(TESTS_SIMPLE_TARGET)

